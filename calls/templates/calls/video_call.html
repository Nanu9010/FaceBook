{% extends "base.html" %}
{% block title %}Video Call{% endblock %}

{% block content %}
<div class="call-container">
    <h2>Video Call with {{ receiver.username }}</h2>

    <div class="video-grid">
        <video id="localVideo" autoplay playsinline muted></video>
        <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <div class="call-controls">
        <button id="startCall" class="btn btn-primary">ğŸ“ Start Call</button>
        <button id="toggleMute" class="btn btn-secondary">ğŸ¤</button>
        <button id="toggleVideo" class="btn btn-secondary">ğŸ“¹</button>
        <button id="hangUp" class="btn btn-danger">âŒ Hang Up</button>
    </div>

    <p id="callStatus">Idle</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
let localStream;
let peerConnection;
let ws;
let isMuted = false;
let isVideoOff = false;

const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const startCallBtn = document.getElementById("startCall");
const hangUpBtn = document.getElementById("hangUp");
const toggleMuteBtn = document.getElementById("toggleMute");
const toggleVideoBtn = document.getElementById("toggleVideo");
const callStatus = document.getElementById("callStatus");

// WebSocket
function initWebSocket() {
    ws = new WebSocket(`ws://${window.location.host}/ws/call/{{ receiver.id }}/`);

    ws.onmessage = async (event) => {
        const data = JSON.parse(event.data);

        if (data.offer) {
            await createPeerConnection();
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            ws.send(JSON.stringify({ answer }));
            callStatus.textContent = "Call Incoming";
        }
        else if (data.answer) {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
            callStatus.textContent = "Connected";
        }
        else if (data.candidate) {
            try {
                await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
            } catch (err) { console.error(err); }
        }
        else if (data.callEnded) {
            endCall();
        }
    };
}

async function createPeerConnection() {
    peerConnection = new RTCPeerConnection(config);

    // Add local tracks
    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

    // Remote track
    peerConnection.ontrack = (event) => {
        remoteVideo.srcObject = event.streams[0];
    };

    // ICE candidates
    peerConnection.onicecandidate = (event) => {
        if (event.candidate) ws.send(JSON.stringify({ candidate: event.candidate }));
    };
}

startCallBtn.addEventListener("click", async () => {
    try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;

        await createPeerConnection();
        initWebSocket();

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        ws.onopen = () => ws.send(JSON.stringify({ offer }));

        callStatus.textContent = "Calling...";
    } catch (err) {
        alert("Cannot access camera/mic");
        console.error(err);
    }
});

hangUpBtn.addEventListener("click", () => {
    ws.send(JSON.stringify({ callEnded: true }));
    endCall();
});

toggleMuteBtn.addEventListener("click", () => {
    if (localStream) {
        const track = localStream.getAudioTracks()[0];
        if (track) {
            track.enabled = !track.enabled;
            isMuted = !track.enabled;
            toggleMuteBtn.textContent = isMuted ? "ğŸ”‡" : "ğŸ¤";
        }
    }
});

toggleVideoBtn.addEventListener("click", () => {
    if (localStream) {
        const track = localStream.getVideoTracks()[0];
        if (track) {
            track.enabled = !track.enabled;
            isVideoOff = !track.enabled;
            toggleVideoBtn.textContent = isVideoOff ? "ğŸš«" : "ğŸ“¹";
        }
    }
});

function endCall() {
    if (peerConnection) peerConnection.close();
    if (localStream) localStream.getTracks().forEach(t => t.stop());
    localVideo.srcObject = null;
    remoteVideo.srcObject = null;
    peerConnection = null;
    localStream = null;
    callStatus.textContent = "Call Ended";
}
</script>
{% endblock %}
